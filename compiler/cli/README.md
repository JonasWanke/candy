# üç≠¬†Candy CLI

## Profiling

All commands below assume they are run from the root of the repository.

Create a [flamegraph](https://github.com/flamegraph-rs/flamegraph#readme):

```bash
CARGO_PROFILE_RELEASE_DEBUG=true cargo flamegraph --bin=candy --deterministic --output=<output file name> -- run <candy file>
# For example:
CARGO_PROFILE_RELEASE_DEBUG=true cargo flamegraph --bin=candy --deterministic --output=flamegraph.svg -- run packages/Examples/fibonacci.candy
```

Use [hyperfine](https://github.com/sharkdp/hyperfine#readme):

```bash
hyperfine --warmup 1 "cargo run --release -- run <candy file>"
# For example:
hyperfine --warmup 1 "cargo run --release -- run packages/Examples/fibonacci.candy"
```

Use Valgrind's Callgrind and KCachegrind:

1. Comment out `RUSTFLAGS` in `flake.nix` (if you're using Nix), but don't commit this change.
   Valgrind doesn't currently support the debug info generated by Mold, which is configured by this environment variable.
2. Build the compiler in release mode with full debug information and run the program with Valgrind.
   An execution with Callgrind and Cachegrind information collection can look like this:

   ```bash
   CARGO_PROFILE_RELEASE_DEBUG=true cargo build --manifest-path compiler/cli/Cargo.toml --release && valgrind --tool=
   callgrind --dump-instr=yes --collect-jumps=yes --simulate-cache=yes target/release/candy run packages/Examples/fibonacci.candy -- 20
   ```

3. Open the generated file `callgrind.out.<pid>` with KCachegrind.
